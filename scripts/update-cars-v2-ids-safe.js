// Script s√©curis√© pour normaliser et mettre √† jour les IDs dans cars_v2
// Usage: node scripts/update-cars-v2-ids-safe.js

const { createClient } = require('@supabase/supabase-js');
const dotenv = require('dotenv');
const path = require('path');

// Charger les variables d'environnement depuis .env.local
dotenv.config({ path: path.join(__dirname, '..', '.env.local') });

// Configuration Supabase
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('‚ùå Variables d\'environnement manquantes');
  console.log('NEXT_PUBLIC_SUPABASE_URL:', supabaseUrl ? '‚úÖ' : '‚ùå');
  console.log('SUPABASE_SERVICE_ROLE_KEY:', supabaseServiceKey ? '‚úÖ' : '‚ùå');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseServiceKey);

// Cache pour optimiser les requ√™tes
const cache = {
  brands: new Map(),
  models: new Map(),
  carTypes: new Map(),
  fuelTypes: new Map()
};

// Liste des exceptions pour les mod√®les (√† conserver en majuscule ou avec tirets)
const MODEL_EXCEPTIONS = new Set([
  // Mercedes
  'GLA', 'GLB', 'GLC', 'GLE', 'GLS', 'CLA', 'CLS', 'EQA', 'EQB', 'EQC', 'EQE', 'EQS',
  // BMW
  'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'iX', 'i4', 'i7', 'iX1', 'iX3',
  // Audi
  'Q3', 'Q4', 'Q5', 'Q7', 'Q8', 'A1', 'A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'e-tron', 'Q3 Sportback',
  // Volkswagen
  'ID.3', 'ID.4', 'ID.5', 'ID.7', 'T-Cross', 'T-Roc', 'Tiguan', 'Touareg',
  // Peugeot
  '2008', '3008', '5008', 'e-2008', 'e-3008', 'e-5008',
  // Citro√´n
  'C3', 'C4', 'C5', 'e-C4', 'e-C4 X',
  // Renault
  'ZOE', 'Kangoo', 'Captur', 'Clio', 'Megane', 'Scenic',
  // Honda
  'CR-V', 'HR-V', 'e:Ny1', 'Civic', 'Jazz',
  // Mazda
  'CX-3', 'CX-30', 'CX-5', 'CX-60', 'MX-30',
  // Volvo
  'EX30', 'EX90', 'XC40', 'XC60', 'XC90', 'C40',
  // Tesla
  'Model S', 'Model 3', 'Model X', 'Model Y', 'Cybertruck',
  // Autres
  'Leaf', 'Ariya', 'Ioniq', 'Kona', 'Tucson', 'Santa Fe', 'Sportage', 'Sorento',
  'Outlander', 'Eclipse Cross', 'ASX', 'Tiguan', 'Touareg', 'Arteon', 'Golf',
  'Polo', 'Passat', 'T-Cross', 'T-Roc', 'ID.3', 'ID.4', 'ID.5', 'ID.7'
]);

/**
 * Normalise une cha√Æne de caract√®res (premi√®re lettre en majuscule, reste en minuscule)
 */
function normalizeString(str) {
  if (!str || typeof str !== 'string') return str;
  
  const trimmed = str.trim();
  if (!trimmed) return str;
  
  return trimmed.charAt(0).toUpperCase() + trimmed.slice(1).toLowerCase();
}

/**
 * Normalise un nom de mod√®le en respectant les exceptions
 */
function normalizeModel(model) {
  if (!model || typeof model !== 'string') return model;
  
  const trimmed = model.trim();
  if (!trimmed) return model;
  
  if (MODEL_EXCEPTIONS.has(trimmed.toUpperCase())) {
    return trimmed.toUpperCase();
  }
  
  return normalizeString(trimmed);
}

/**
 * R√©cup√®re ou cr√©e une marque et retourne son ID
 */
async function getOrCreateBrand(brandName) {
  if (!brandName) return null;
  
  const normalizedBrand = normalizeString(brandName);
  
  if (cache.brands.has(normalizedBrand)) {
    return cache.brands.get(normalizedBrand);
  }
  
  try {
    // Chercher la marque existante
    let { data: existingBrand, error: searchError } = await supabase
      .from('brands')
      .select('id')
      .eq('name', normalizedBrand)
      .single();
    
    if (searchError && searchError.code !== 'PGRST116') {
      console.error(`‚ùå Erreur lors de la recherche de la marque "${normalizedBrand}":`, searchError.message);
      return null;
    }
    
    let brandId;
    
    if (existingBrand) {
      brandId = existingBrand.id;
      console.log(`   ‚úÖ Marque trouv√©e: "${normalizedBrand}" (ID: ${brandId})`);
    } else {
      // Cr√©er la nouvelle marque
      const { data: newBrand, error: createError } = await supabase
        .from('brands')
        .insert({ name: normalizedBrand })
        .select('id')
        .single();
      
      if (createError) {
        console.error(`‚ùå Erreur lors de la cr√©ation de la marque "${normalizedBrand}":`, createError.message);
        return null;
      }
      
      brandId = newBrand.id;
      console.log(`   ‚ûï Marque cr√©√©e: "${normalizedBrand}" (ID: ${brandId})`);
    }
    
    cache.brands.set(normalizedBrand, brandId);
    return brandId;
    
  } catch (error) {
    console.error(`‚ùå Erreur inattendue pour la marque "${normalizedBrand}":`, error.message);
    return null;
  }
}

/**
 * R√©cup√®re ou cr√©e un mod√®le et retourne son ID
 */
async function getOrCreateModel(modelName, brandId) {
  if (!modelName || !brandId) return null;
  
  const normalizedModel = normalizeModel(modelName);
  const cacheKey = `${brandId}-${normalizedModel}`;
  
  if (cache.models.has(cacheKey)) {
    return cache.models.get(cacheKey);
  }
  
  try {
    // Chercher le mod√®le existant
    let { data: existingModel, error: searchError } = await supabase
      .from('models')
      .select('id')
      .eq('name', normalizedModel)
      .eq('brand_id', brandId)
      .single();
    
    if (searchError && searchError.code !== 'PGRST116') {
      console.error(`‚ùå Erreur lors de la recherche du mod√®le "${normalizedModel}":`, searchError.message);
      return null;
    }
    
    let modelId;
    
    if (existingModel) {
      modelId = existingModel.id;
      console.log(`   ‚úÖ Mod√®le trouv√©: "${normalizedModel}" (ID: ${modelId})`);
    } else {
      // Cr√©er le nouveau mod√®le
      const { data: newModel, error: createError } = await supabase
        .from('models')
        .insert({ 
          name: normalizedModel, 
          brand_id: brandId 
        })
        .select('id')
        .single();
      
      if (createError) {
        console.error(`‚ùå Erreur lors de la cr√©ation du mod√®le "${normalizedModel}":`, createError.message);
        return null;
      }
      
      modelId = newModel.id;
      console.log(`   ‚ûï Mod√®le cr√©√©: "${normalizedModel}" (ID: ${modelId})`);
    }
    
    cache.models.set(cacheKey, modelId);
    return modelId;
    
  } catch (error) {
    console.error(`‚ùå Erreur inattendue pour le mod√®le "${normalizedModel}":`, error.message);
    return null;
  }
}

/**
 * R√©cup√®re ou cr√©e un type de v√©hicule et retourne son ID
 */
async function getOrCreateCarType(typeName) {
  if (!typeName) return null;
  
  const normalizedType = normalizeString(typeName);
  
  if (cache.carTypes.has(normalizedType)) {
    return cache.carTypes.get(normalizedType);
  }
  
  try {
    // Chercher le type existant
    let { data: existingType, error: searchError } = await supabase
      .from('car_types')
      .select('id')
      .eq('name', normalizedType)
      .single();
    
    if (searchError && searchError.code !== 'PGRST116') {
      console.error(`‚ùå Erreur lors de la recherche du type "${normalizedType}":`, searchError.message);
      return null;
    }
    
    let typeId;
    
    if (existingType) {
      typeId = existingType.id;
      console.log(`   ‚úÖ Type trouv√©: "${normalizedType}" (ID: ${typeId})`);
    } else {
      // Cr√©er le nouveau type
      const { data: newType, error: createError } = await supabase
        .from('car_types')
        .insert({ name: normalizedType })
        .select('id')
        .single();
      
      if (createError) {
        console.error(`‚ùå Erreur lors de la cr√©ation du type "${normalizedType}":`, createError.message);
        return null;
      }
      
      typeId = newType.id;
      console.log(`   ‚ûï Type cr√©√©: "${normalizedType}" (ID: ${typeId})`);
    }
    
    cache.carTypes.set(normalizedType, typeId);
    return typeId;
    
  } catch (error) {
    console.error(`‚ùå Erreur inattendue pour le type "${normalizedType}":`, error.message);
    return null;
  }
}

/**
 * R√©cup√®re ou cr√©e un type de carburant et retourne son ID
 */
async function getOrCreateFuelType(fuelTypeName) {
  if (!fuelTypeName) return null;
  
  const normalizedFuelType = normalizeString(fuelTypeName);
  
  if (cache.fuelTypes.has(normalizedFuelType)) {
    return cache.fuelTypes.get(normalizedFuelType);
  }
  
  try {
    // Chercher le type de carburant existant
    let { data: existingFuelType, error: searchError } = await supabase
      .from('fuel_types')
      .select('id')
      .eq('name', normalizedFuelType)
      .single();
    
    if (searchError && searchError.code !== 'PGRST116') {
      console.error(`‚ùå Erreur lors de la recherche du carburant "${normalizedFuelType}":`, searchError.message);
      return null;
    }
    
    let fuelTypeId;
    
    if (existingFuelType) {
      fuelTypeId = existingFuelType.id;
      console.log(`   ‚úÖ Carburant trouv√©: "${normalizedFuelType}" (ID: ${fuelTypeId})`);
    } else {
      // Cr√©er le nouveau type de carburant
      const { data: newFuelType, error: createError } = await supabase
        .from('fuel_types')
        .insert({ name: normalizedFuelType })
        .select('id')
        .single();
      
      if (createError) {
        console.error(`‚ùå Erreur lors de la cr√©ation du carburant "${normalizedFuelType}":`, createError.message);
        return null;
      }
      
      fuelTypeId = newFuelType.id;
      console.log(`   ‚ûï Carburant cr√©√©: "${normalizedFuelType}" (ID: ${fuelTypeId})`);
    }
    
    cache.fuelTypes.set(normalizedFuelType, fuelTypeId);
    return fuelTypeId;
    
  } catch (error) {
    console.error(`‚ùå Erreur inattendue pour le carburant "${normalizedFuelType}":`, error.message);
    return null;
  }
}

/**
 * Met √† jour une voiture avec les IDs normalis√©s (version s√©curis√©e)
 */
async function updateCarSafe(car) {
  console.log(`\nüîÑ Traitement de la voiture ID ${car.id}:`);
  console.log(`   Original - Marque: "${car.brand}", Mod√®le: "${car.model}", Type: "${car.type}", Carburant: "${car.fuel_type}"`);
  
  // Normaliser les donn√©es
  const normalizedBrand = normalizeString(car.brand);
  const normalizedModel = normalizeModel(car.model);
  const normalizedType = normalizeString(car.type);
  const normalizedFuelType = normalizeString(car.fuel_type);
  
  console.log(`   Normalis√© - Marque: "${normalizedBrand}", Mod√®le: "${normalizedModel}", Type: "${normalizedType}", Carburant: "${normalizedFuelType}"`);
  
  // R√©cup√©rer ou cr√©er les IDs
  const brandId = await getOrCreateBrand(normalizedBrand);
  const modelId = brandId ? await getOrCreateModel(normalizedModel, brandId) : null;
  const carTypeId = await getOrCreateCarType(normalizedType);
  const fuelTypeId = await getOrCreateFuelType(normalizedFuelType);
  
  // Mettre √† jour chaque champ individuellement pour √©viter les probl√®mes de triggers
  let successCount = 0;
  
  if (brandId !== null) {
    try {
      const { error } = await supabase
        .from('cars_v2')
        .update({ brand_id: brandId })
        .eq('id', car.id);
      
      if (error) {
        console.error(`   ‚ùå Erreur mise √† jour brand_id: ${error.message}`);
      } else {
        console.log(`   ‚úÖ brand_id mis √† jour: ${brandId}`);
        successCount++;
      }
    } catch (error) {
      console.error(`   ‚ùå Erreur inattendue brand_id: ${error.message}`);
    }
  }
  
  if (modelId !== null) {
    try {
      const { error } = await supabase
        .from('cars_v2')
        .update({ model_id: modelId })
        .eq('id', car.id);
      
      if (error) {
        console.error(`   ‚ùå Erreur mise √† jour model_id: ${error.message}`);
      } else {
        console.log(`   ‚úÖ model_id mis √† jour: ${modelId}`);
        successCount++;
      }
    } catch (error) {
      console.error(`   ‚ùå Erreur inattendue model_id: ${error.message}`);
    }
  }
  
  if (carTypeId !== null) {
    try {
      const { error } = await supabase
        .from('cars_v2')
        .update({ vehicle_type_id: carTypeId })
        .eq('id', car.id);
      
      if (error) {
        console.error(`   ‚ùå Erreur mise √† jour vehicle_type_id: ${error.message}`);
      } else {
        console.log(`   ‚úÖ vehicle_type_id mis √† jour: ${carTypeId}`);
        successCount++;
      }
    } catch (error) {
      console.error(`   ‚ùå Erreur inattendue vehicle_type_id: ${error.message}`);
    }
  }
  
  if (fuelTypeId !== null) {
    try {
      const { error } = await supabase
        .from('cars_v2')
        .update({ fuel_type_id: fuelTypeId })
        .eq('id', car.id);
      
      if (error) {
        console.error(`   ‚ùå Erreur mise √† jour fuel_type_id: ${error.message}`);
      } else {
        console.log(`   ‚úÖ fuel_type_id mis √† jour: ${fuelTypeId}`);
        successCount++;
      }
    } catch (error) {
      console.error(`   ‚ùå Erreur inattendue fuel_type_id: ${error.message}`);
    }
  }
  
  if (successCount > 0) {
    console.log(`   ‚úÖ ${successCount} champ(s) mis √† jour avec succ√®s`);
    return true;
  } else {
    console.log(`   ‚ö†Ô∏è  Aucun champ mis √† jour`);
    return false;
  }
}

/**
 * Fonction principale pour traiter toutes les voitures (version s√©curis√©e)
 */
async function updateCarsV2IdsSafe() {
  console.log('üöÄ D√©but de la normalisation et mise √† jour des IDs dans cars_v2 (version s√©curis√©e)...\n');
  
  try {
    // R√©cup√©rer toutes les voitures
    console.log('üìã R√©cup√©ration de toutes les voitures...');
    const { data: cars, error } = await supabase
      .from('cars_v2')
      .select('id, brand, model, type, fuel_type')
      .order('id');
    
    if (error) {
      throw new Error(`Erreur lors de la r√©cup√©ration des voitures: ${error.message}`);
    }
    
    console.log(`‚úÖ ${cars.length} voitures trouv√©es\n`);
    
    // Statistiques
    let updatedCount = 0;
    let errorCount = 0;
    
    // Traiter chaque voiture
    for (let i = 0; i < cars.length; i++) {
      const car = cars[i];
      console.log(`\nüìä Progression: ${i + 1}/${cars.length} (${Math.round(((i + 1) / cars.length) * 100)}%)`);
      
      const success = await updateCarSafe(car);
      
      if (success) {
        updatedCount++;
      } else {
        errorCount++;
      }
      
      // Pause plus longue pour √©viter les probl√®mes de triggers
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    // R√©sum√© final
    console.log('\nüéâ Traitement termin√© !');
    console.log('\nüìä R√©sum√©:');
    console.log(`   ‚úÖ Voitures mises √† jour: ${updatedCount}`);
    console.log(`   ‚ùå Erreurs: ${errorCount}`);
    console.log(`   üìã Total trait√©: ${cars.length}`);
    
    // Afficher les statistiques du cache
    console.log('\nüíæ Statistiques du cache:');
    console.log(`   Marques mises en cache: ${cache.brands.size}`);
    console.log(`   Mod√®les mis en cache: ${cache.models.size}`);
    console.log(`   Types de v√©hicules mis en cache: ${cache.carTypes.size}`);
    console.log(`   Types de carburant mis en cache: ${cache.fuelTypes.size}`);
    
  } catch (error) {
    console.error('\n‚ùå Erreur lors du traitement:', error.message);
    process.exit(1);
  }
}

/**
 * Fonction principale
 */
async function main() {
  const command = process.argv[2];
  
  switch (command) {
    case 'update':
      await updateCarsV2IdsSafe();
      break;
    default:
      console.log('Usage:');
      console.log('  node scripts/update-cars-v2-ids-safe.js update  - Normaliser et mettre √† jour les IDs (version s√©curis√©e)');
      break;
  }
}

main(); 